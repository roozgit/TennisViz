<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tennis ViZ; Roozbeh Khodadadeh; CSE 578; 9-5-2018</title>
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script type="text/javascript" src="js/d3.js"></script>
    <script src="https://unpkg.com/d3-force-attract@latest"></script>
    <script src="https://unpkg.com/d3-force-cluster@latest"></script>
</head>
<body>
<script type="text/javascript" src="globals.js"></script>
<script>
    function drawEverything() {
        d3.select("svg").remove();
        let z = d3.scaleOrdinal(d3.schemeAccent);
        let m = 7; //number of clusters
        let clusters = d3.range(0, 7).map(c => {
            return {
                r: 100,
                x: Math.cos(c / m * 2 * Math.PI) * 400 + leftChartWidth / 2 + Math.random(),
                y: Math.sin(c / m * 2 * Math.PI) * 400 + leftChartHeight / 2 + Math.random()
            };
        });

        graph.nodes
            .forEach(n => {
                n.cluster = Math.floor(playerData.get(n.id).wins / 10);
                n.radius = (playerData.get(n.id).hero  + 1) * 10;
            });

        //D3
        let leftChart = d3.select('body').append('svg')
            .attr('width', leftChartWidth)
            .attr('height', leftChartHeight)
            .style('border', "1px solid black")
            .on('click', () => {
                d3.selectAll("circle").style('opacity', 1);
                d3.selectAll(".links")
                    .style('stroke-width', 1)
                    .style('opacity', .2);
                d3.selectAll("text")
                    .style("visibility", "hidden");
            });

        var link = leftChart.append("g")
            .selectAll(".links")
            .data(graph.edges)
            .enter()
            .append("path")
            .attr("class", "links")
            .attr("stroke-width", "1px")
            .attr("fill","none")
            .attr("stroke", "lightgray");

        var node = leftChart.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(graph.nodes)
            .enter().append("circle")
            .attr("r", d => d.radius)
            .attr('fill', d => z(d.cluster))
            .on("mouseover", click)
            .call(d3.drag()
                .on("start", d => {
                    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d3.event.subject.x;
                    d.fy = d3.event.subject.y;
                })
                .on("drag", d => {
                    d.fx = d3.event.x;
                    d.fy = d3.event.y;
                })
                .on("end", d => {
                    if (!d3.event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }));

        let labels = leftChart.append("g")
            .attr("class","labels")
            .selectAll("text")
            .data(graph.nodes)
            .enter().append('text')
            .attr("dx", 14)
            .attr("dy", ".4em")
            .style("visibility", "hidden")
            .text(d => d.id + "(" + d.country +")");

        let simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(0.1).strength(.001))
            .force("charge", d3.forceManyBody().strength(1))
            .force("center", d3.forceCenter(leftChartWidth / 2, leftChartHeight / 2))
            .force('attract', d3.forceAttract()
               .target([leftChartWidth/2, leftChartHeight/2])
               .strength(0.01))
            .force('cluster', d3.forceCluster()
               .centers(function (d) { return clusters[d.cluster]; })
               .strength(0.5)
               .centerInertia(0.6))

            //.force("cluster", cluster().strength(.08))
            .force('collide', d3.forceCollide(d => d.radius + 5).strength(0.9));

        simulation.nodes(graph.nodes)
            .on("tick", () => {
                link.attr("d", d => {
                    let dx = d.target.x - d.source.x,
                        dy = d.target.y - d.source.y,
                        dr = Math.sqrt(dx * dx + dy * dy)*(d.gameNo-1);
                    return "M" + d.source.x + "," + d.source.y + "A" + dr + ","
                        + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
                });

                node.attr("cx", d => d.x)
                    .attr("cy", d => d.y)
                    .attr("r", d => d.radius);

                labels.attr("x", d => d.x)
                    .attr("y", d => d.y)
            });

        simulation.force("link").links(graph.edges);

        d3.select("#tourney").on("change", filterTourney);

        function filterTourney() {
            let value = this.value;
            let ecollection = graph.edges.filter(x => x.tourneyYear === value);
            let n1c = [...(new Set(ecollection.map(x => x.source.id)))];
            let n2c = [...(new Set(ecollection.map(x => x.target.id)))];
            let nc = [...(new Set(n1c.concat(n2c)))];
            let ncollection = graph.nodes.filter(x => nc.includes(x.id));

            link = d3.selectAll(".links")
                .data(ecollection);
            node = d3.selectAll("circle")
                .data(ncollection);

            link.exit().remove();
            node.exit().remove();
            simulation.alphaTarget(.02).restart();
            d3.select("select").attr("disabled","disabled");
        }

        function click(d) {
            d3.event.stopPropagation();
            d3.selectAll("circle")
                .style('opacity', 0.2);
            d3.selectAll(".links")
                .style('opacity', .2)
                .style('stroke','lightgray')
                .style('stroke-width', 1);
            d3.selectAll("text").style("visibility","hidden");

            let connected = d3.selectAll(".links")
                .filter(x => x.source.id === d.id || x.target.id === d.id);

            connected.style('stroke','black')
                .style('stroke-width', 2)
                .style('opacity', 1);
            connected.each(br => {
                d3.selectAll("circle").filter(x => x.id === br.source.id ||
                    x.id === br.target.id)
                    .style('opacity', 1);

                d3.selectAll("text").filter(x => x.id === br.source.id ||
                    x.id === br.target.id)
                    .style('visibility', "visible");

            });
        }

    }

    //Second chart
    function drawDetail() {
        for(let v of playerData.values()) {
            for(let p of Object.getOwnPropertyNames(v)) {
                if(!summary.dims[p]) summary.dims[p] = [];
                if(p === "hero" || p === "wins")
                    summary.dims[p].push(v[p]);
                else summary.dims[p] = summary.dims[p].concat(v[p].filter(x => x === 0 ? true : Boolean(x)));
            }
        }
        for(let p of Object.getOwnPropertyNames(summary.dims)) {
            summary.dims[p].sort();
            summary.stats.average[p] = d3.sum(summary.dims[p])/summary.dims[p].length;
            let dimlen = summary.dims[p].length;
            summary.stats.median[p] = dimlen % 2 === 1 ? summary.dims[p][Math.floor(dimlen / 2)] :
                (summary.dims[p][Math.floor(dimlen / 2)] + summary.dims[p][Math.floor(dimlen / 2) -1]) / 2;
            summary.stats.maximum[p] = d3.max(summary.dims[p]);
            summary.stats.minimum[p] = d3.min(summary.dims[p]);
            summary.stats.extent[p] = d3.extent(summary.dims[p]);
        }
        console.log(summary);
        //let x = d3.scaleOrdinal().domain()
    }

    //controls
    function registerControls() {
        let trange = d3.range(2003, 2015);
        let sel = d3.select("body")
            .append("select")
            .attr("id","tourney")
            .selectAll("option")
            .data(trange)
            .enter()
            .append("option")
            .attr("value", d => d)
            .text(d => d);
        d3.select("body").append("button")
            .attr("id","reset").text("Reset")
            .on("click", () => {
                d3.select("select").attr("disabled", null);
                drawEverything()
            });

    }

    /*
      __  __          _____ _   _
     |  \/  |   /\   |_   _| \ | |
     | \  / |  /  \    | | |  \| |
     | |\/| | / /\ \   | | | . ` |
     | |  | |/ ____ \ _| |_| |\  |
     |_|  |_/_/    \_\_____|_| \_|
        */
    var proxyUrl = 'https://cors-anywhere.herokuapp.com/',
        targetUrl = 'https://sites.google.com/a/asu.edu/cse-578-fall-2018/homework/hw-2-d3-programming/10yearAUSOpenMatches.csv?attredirects=0&d=1'
    d3.csv("data.csv").then(data => {
        data.forEach( d => {
            let ed = new Edge(d['player1'], d['player2'], d['round'], d['year']);

            if(playerData.get(d['player1']) === undefined) {
                graph.nodes.push(new Node(d['player1'], d['country1']));
                playerData.set(d['player1'], new PlayerStats());
                updateStats(playerData.get(d['player1']),d , 1);
            } else
                updateStats(playerData.get(d['player1']),d , 1);

            if(playerData.get(d['player2']) === undefined) {
                graph.nodes.push(new Node(d['player2'], d['country2']));
                playerData.set(d['player2'], new PlayerStats());
                updateStats(playerData.get(d['player2']),d , 2);
            } else
                updateStats(playerData.get(d['player2']),d , 2);

            if(graph.edges.some(ex => ex.source === ed.source && ex.target === ed.target))
                ed.gameNo += 1;

            graph.edges.push(ed);
        })
    }).then(registerControls)
        .then(drawEverything)
        .then(drawDetail);

</script>
</body>
</html>
